@using LegendCR.CommonDefinitions.DTO
@using LegendCR.CommonDefinitions.DTO.ShipmentDTOs
@using LegendCR.DAL.DB;
@using LegendCR.Helpers;
@using LegendCR.BL.Services;
@model ShipDTO
@{
    var roleid = AuthHelper.GetClaimValue(User, "RoleID");
    var checkStatusIDsForCancel = new List<int>
    {
        (int)EnumStatus.Ready_For_Pickup, (int)EnumStatus.Assigned_For_Pickup, (int)EnumStatus.Picked_Up,
        (int)EnumStatus.Ready_For_Return, (int)EnumStatus.Assigned_For_Return, (int)EnumStatus.Out_For_Return
    };
}

<div class="list-container" id="button-list_@Model.ShipmentId">
    <button class="more-button" onclick="Toglebutton(@Model.ShipmentId)" aria-label="Menu Button">
        <div class="menu-icon-wrapper">
            <div class="menu-icon-line half first"></div>
            <div class="menu-icon-line"></div>
            <div class="menu-icon-line half last"></div>
        </div>
    </button>
    <ul class="more-button-list">
        @if (roleid == (int)EnumRole.Admin)
        {
            <li class="more-button-list-item">
                <i class="fa fa-pencil-square-o F-Large" aria-hidden="true"></i>
                <a href="/Shipment/Edit?shipID=@Model.ShipmentId" target="_blank">Edit</a>
            </li>
        }
        else
        {
            <li class="more-button-list-item">
                <i class="fa fa-pencil-square-o F-Large" aria-hidden="true"></i>
                <a data-toggle="modal" data-target="#divEditAddress_@Model.ShipmentId">Edit</a>
            </li>
        }

        @if (Model.StatusDTO.Id == (int)EnumStatus.Assigned_For_Delivery
        || Model.StatusDTO.Id == (int)EnumStatus.Assigned_For_Return
        || Model.StatusDTO.Id == (int)EnumStatus.Assigned_For_Refund)
        {
            <li class="more-button-list-item" id="Unassigned_@Model.ShipmentId" title="Unassign">
                <i class="fa fa-undo F-Large" aria-hidden="true"></i>
                <a href="javascript:;" onclick="UnassignedShipmnet(@Model.ShipmentId)">Unassign</a>
            </li>
        }

        <li class="more-button-list-item">
            <i class="fa fa-times fa-2x"></i>
            <a data-toggle="modal" data-target="#divCancel_@Model.ShipmentId">Cancel</a>
        </li>

        <li class="more-button-list-item">
            <i class="fa fa-phone F-Large" aria-hidden="true"></i>
            <a data-toggle="modal" data-target="#divConfirm_@Model.ShipmentId">Customer Followup Call</a>
        </li>

        <li class="more-button-list-item">
            <i class="icon-calendar F-Medium"></i>
            <a data-toggle="modal" data-target="#divPostpone_@Model.ShipmentId">Postpone</a>
        </li>

        <li class="more-button-list-item">
            <i class="icon-info F-Large"></i>
            <a style="margin-Top:5px;" data-toggle="modal" data-target="#divProblem_@Model.ShipmentId">Report Problem</a>
        </li>
    </ul>
</div>

<!--Actions  Popup -->
<div class="modal fade" id="divCancel_@Model.ShipmentId" tabindex="-1" role="dialog" aria-hidden="true" style="text-align:left">
    <div class="modal-dialog modal-lg " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="Modal-Lablel">
                    Code : <label>@Model.RefId</label>
                    <br />
                    Customer : <label>@Model.CustomerDetailsDTO.CustomerName</label>
                    <br />
                    Phone : <label>@Model.CustomerDetailsDTO.CustomerPhone - @Model.CustomerDetailsDTO.CustomerPhone2</label>
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="container-fluid P-Model">
                <div class="row">
                    <h6 class="Label-Model">Reason :</h6>
                    @Html.DropDownList("ProblemTypeId", new SelectList(ViewBag.CancelReason, nameof(ProblemType.ProblemTypeId),nameof(ProblemType.NameEn)),
                    "--- Select Cancel Reason ---", new { @class="input-Model", @id=$"Reason_{@Model.ShipmentId}" })

                    <h6 class="Label-Model pt-3">Cancellation Comments :</h6>
                    <textarea rows="4" type="text" id="noteCancel_@Model.ShipmentId" placeholder="Your Comments ..."></textarea>

                    @if (!checkStatusIDsForCancel.Contains(Model.StatusId))
                    {
                        <h6 class="Label-Model pt-3">Is Trip Completed !?</h6>
                        @if (Model.FeesDetailsDTO.ShippingFeesPaid > 0)
                        {
                            <input class="mt-3 ml-3" type="checkbox" id="cbxIsTripCompleted_@Model.ShipmentId" checked="checked" disabled />
                        }
                        else
                        {
                            <input class="mt-3 ml-3" type="checkbox" id="cbxIsTripCompleted_@Model.ShipmentId" />
                        }
                    }
                </div>
                @if (!checkStatusIDsForCancel.Contains(Model.StatusId))
                {
                    <div class="row">
                        <h6 class="Label-Model pt-3">Cash Collected :</h6>
                        <label class="font-weight-bold pl-2 pt-2" style="font-size: 18px">@Model.FeesDetailsDTO.ShippingFeesPaid EGP</label>
                    </div>
                    <div class="row">
                        <h6 class="font-w-500 mt-3">
                            Cancellation Details
                            <br />
                            <i class="fas fa-info-circle F-Medium mt-3"></i>
                            <label style="font-size: 12px;">
                                <b class="text-danger">
                                    @{
                                        double result;
                                        if (Model.StatusId == (int)EnumStatus.Ready_For_Refund || Model.StatusId == (int)EnumStatus.Assigned_For_Refund || Model.StatusId == (int)EnumStatus.Out_For_Refund)
                                        {
                                            result = Model.FeesDetailsDTO.Total - Model.RefundCash.Value;
                                        }
                                        else
                                        {
                                            result = Model.FeesDetailsDTO.Total - Model.FeesDetailsDTO.VendorCash;
                                        }
                                    }
                                    @result EGP  <label style="font-size: 11px; color:#ff000096">(Shipping Fees)</label>
                                </b>
                                will applied if <b>TRIP is completed.</b>
                            </label>

                            <br />
                            <i class="fas fa-info-circle F-Medium"></i>
                            <label style="font-size: 12px;"><b class="text-danger">@BaseHelper.Constants.CancelFees EGP <label style="font-size: 11px; color:#ff000096">(Cancel Fees)</label></b> will applied if <b>TRIP IS NOT completed</b></label>
                        </h6>
                    </div>
                }
                else
                {
                    <div class="row">
                        <h6 class="font-w-500 mt-3">
                            Cancellation Details
                            <br /><br />
                            <i class="fas fa-info-circle F-Medium"></i>
                            <label style="font-size: 12px;">No Fees will applied on cancel.</label>
                        </h6>
                    </div>
                }
            </div>
            <div class="col-lg-12">
                <button class="Red-Btn-OutLine OutLine-Red Btn-Model" type="button" onclick="CancelOrder('@Model.ShipmentId', $('#noteCancel_@Model.ShipmentId').val(), 'TableRow_@Model.ShipmentId')" data-dismiss="modal">Cancel Shipment</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="divConfirm_@Model.ShipmentId" tabindex="-1" role="dialog" aria-hidden="true" style="text-align:left">
    <div class="modal-dialog modal-dialog-centered modal-lg " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="Modal-Lablel">
                    Code : <label>@Model.RefId</label>
                    <br />
                    Customer : <label>@Model.CustomerDetailsDTO.CustomerName</label>
                    <br />
                    Phone : <label>@Model.CustomerDetailsDTO.CustomerPhone - @Model.CustomerDetailsDTO.CustomerPhone2</label>
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="container-fluid P-Model">
                <div class="row">
                    <di class="col-lg-6">
                        <h6 class="Label-Model pt-3" style="margin-bottom:5px">Call Answer:</h6>
                        <input type="number" id="CallAnswer_@Model.ShipmentId" class="input-Number" value="@Model.CustomerFollowUpDTO.CallAnswerCount" min="0" />
                    </di>
                    <di class="col-lg-6">
                        <h6 class="Label-Model pt-3" style="margin-bottom:5px">Call Not Answer:</h6>
                        <input type="number" id="CallNotAnswer_@Model.ShipmentId" class="input-Number" value="@Model.CustomerFollowUpDTO.CallNotAnswerCount" min="0" />
                    </di>
                </div>
            </div>
            <div class="col-lg-12">
                <button class="Red-Btn-OutLine OutLine-Red Btn-Model" onclick="CallHisory(@Model.ShipmentId)" type="button" data-dismiss="modal">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="divProblem_@Model.ShipmentId" tabindex="-1" role="dialog" aria-hidden="true" style="text-align:left">
    <div class="modal-dialog modal-dialog-centered modal-lg " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="Modal-Lablel">
                    <label style="font-size: 24px; color: black">Report Problem</label>
                    <br /><br />
                    Code : <label>@Model.RefId</label>
                    <br />
                    Customer : <label>@Model.CustomerDetailsDTO.CustomerName</label>
                    <br />
                    Phone : <label>@Model.CustomerDetailsDTO.CustomerPhone - @Model.CustomerDetailsDTO.CustomerPhone2</label>
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="container-fluid P-Model">
                <div class="row">
                    <div class="form-group col-sm-12">
                        <h6 class="Label-Model">Problem Type :</h6>
                        @Html.DropDownList("ProblemTypeId", new SelectList(ViewBag.ProblemType, "ProblemTypeId", "NameEn"), "--- Select Problem Type ---", new { @class="input-Model", @id="ddlReason_"+@Model.ShipmentId+"" })
                    </div>
                    <div class="form-group col-sm-12">
                        <h6 class="Label-Model">Problem :</h6>
                        <textarea rows="4" class="form-control" id="NotesTxt_@Model.ShipmentId"></textarea>
                    </div>
                </div>
            </div>
            <div class="col-lg-12">
                <button class="Red-Btn-OutLine OutLine-Red Btn-Model" type="button" onclick="AddProblem('@Model.ShipmentId',$('#NotesTxt_@Model.ShipmentId').val(),'TableRow_@Model.ShipmentId', $('#ddlReason_@Model.ShipmentId').val())" data-dismiss="modal">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="divEditAddress_@Model.ShipmentId" tabindex="-1" role="dialog" aria-hidden="true" style="text-align:left">
    <div class="modal-dialog modal-dialog-centered modal-lg " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="Modal-Lablel">
                    Code : <label>@Model.RefId</label>
                    <br />
                    Customer : <label>@Model.CustomerDetailsDTO.CustomerName</label>
                    <br />
                    Phone : <label>@Model.CustomerDetailsDTO.CustomerPhone - @Model.CustomerDetailsDTO.CustomerPhone2</label>
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="container-fluid P-Model">
                <div class="row">
                    <div class="col-sm-12 pt-3">
                        <h6 class="Label-Model">Customer Address:</h6>
                        <input class="input-Model" id="CustomerAddressTxt_@Model.ShipmentId" value="@Model.CustomerDetailsDTO.CustomerAddress">
                    </div>
                    <div class="col-sm-12 pt-3">
                        <h6 class="Label-Model">Location :</h6>
                        <input class="input-Model" id="LocationTxt_@Model.ShipmentId" value="@Model.CustomerDetailsDTO.Location">
                    </div>
                    <div class="col-sm-12 pt-3">
                        <h6 class="Label-Model">Landmark :</h6>
                        <input class="input-Model" id="LandmarkTxt_@Model.ShipmentId" value="@Model.CustomerDetailsDTO.Landmark">
                    </div>
                    <div class="col-sm-6 pt-3">
                        <h6 class="Label-Model">Floor :</h6>
                        <input class="input-Model" type="number" min="0" id="FloorTxt_@Model.ShipmentId" value="@Model.CustomerDetailsDTO.Floor">
                    </div>
                    <div class="col-sm-6 pt-3">
                        <h6 class="Label-Model">Apartment :</h6>
                        <input type="number" min="0" class="input-Model" id="ApartmentTxt_@Model.ShipmentId" value="@Model.CustomerDetailsDTO.Apartment">
                    </div>
                </div>
            </div>
            <div class="col-lg-12">
                <button class="Red-Btn-OutLine OutLine-Red Btn-Model" type="button" data-dismiss="modal" onclick="EditAddress('@Model.ShipmentId')">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="divPostpone_@Model.ShipmentId" tabindex="-1" role="dialog" aria-hidden="true" style="text-align:left">
    <div class="modal-dialog modal-dialog-centered modal-lg " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="Modal-Lablel">
                    Code : <label>@Model.RefId</label>
                    <br />
                    Customer : <label>@Model.CustomerDetailsDTO.CustomerName</label>
                    <br />
                    Phone : <label>@Model.CustomerDetailsDTO.CustomerPhone - @Model.CustomerDetailsDTO.CustomerPhone2</label>
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="container-fluid P-Model">
                <div class="row pt-3">
                    <h6 class="Label-Model pt-3" style="margin-bottom:5px">Next Call Date:</h6>
                    <input type="date" id="postponeDate_@Model.ShipmentId" class="form-control">

                    <h6 class="Label-Model pt-3" style="margin-bottom:5px; margin-top:5px;">Next Call Time (From):</h6>
                    <input type="time" id="postponeFrom_@Model.ShipmentId" class="form-control">

                    <h6 class="Label-Model pt-3" style="margin-bottom:5px; margin-top:5px;">Next Call Time (To):</h6>
                    <input type="time" id="postponeTo_@Model.ShipmentId" class="form-control">

                    <h6 class="Label-Model pt-3">Notes:</h6>
                    <textarea class="form-control" id="postponeNote_@Model.ShipmentId" placeholder="Your notes ..." rows="5"></textarea>
                </div>
            </div>
            <div class="col-lg-12">
                <button class="Red-Btn-OutLine OutLine-Red Btn-Model" type="button" onclick="Postpone('@Model.ShipmentId', $('#postponeDate_@Model.ShipmentId').val(), $('#postponeFrom_@Model.ShipmentId').val(), $('#postponeTo_@Model.ShipmentId').val(), $('#postponeNote_@Model.ShipmentId').val(), false , 'divConfirm_@Model.ShipmentId','TableTD_@Model.ShipmentId','TableRow_@Model.ShipmentId')" data-dismiss="modal">Postpone Shipment</button>
            </div>
        </div>
    </div>
</div>